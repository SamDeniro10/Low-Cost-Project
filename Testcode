#include <Wire.h>
#include "SensirionI2CSen5x.h"

// SEN55-Sensor
SensirionI2CSen5x sensor;

// Intervall für Messungen (10 Sekunden)
const unsigned long intervall = 10000;
unsigned long letzteMessung = 0;

void setup() {
    // Serielle Verbindung starten
    Serial.begin(115200);
    Wire.begin();

    // Sensor initialisieren
    Serial.println("Sensor wird initialisiert...");
    sensor.begin(Wire);
    if (sensor.deviceReset()) {
        Serial.println("Fehler: Sensor konnte nicht initialisiert werden!");
        while (true); // Stoppt das Programm
    }

    Serial.println("Sensor erfolgreich initialisiert.");
}

void loop() {
    // Prüfen, ob das Intervall abgelaufen ist
    if (millis() - letzteMessung >= intervall) {
        letzteMessung = millis();
        leseSensordaten();
    }
}

void leseSensordaten() {
    // Variablen für die Sensordaten
    float pm0p5, pm1p0, pm2p5, pm4p0, pm10p0, smallParticles, temperatur, luftfeuchtigkeit, vocIndex, noxIndex;

    // Sensordaten lesen
    if (sensor.readMeasuredPmValues(pm0p5, pm1p0, pm2p5, pm4p0, pm10p0, smallParticles, temperatur, luftfeuchtigkeit, vocIndex, noxIndex)) {
        Serial.println("Fehler beim Lesen der Sensordaten.");
        return;
    }

    // Daten auf dem Serial Monitor anzeigen
    Serial.println("----- Sensordaten -----");
    Serial.print("Temperatur: "); Serial.print(temperatur, 2); Serial.println(" °C");
    Serial.print("Luftfeuchtigkeit: "); Serial.print(luftfeuchtigkeit, 2); Serial.println(" %");
    Serial.print("PM0.5: "); Serial.print(pm0p5, 2); Serial.println(" Partikel/m³");
    Serial.print("PM1.0: "); Serial.print(pm1p0, 2); Serial.println(" Partikel/m³");
    Serial.print("PM2.5: "); Serial.print(pm2p5, 2); Serial.println(" Partikel/m³");
    Serial.print("PM4.0: "); Serial.print(pm4p0, 2); Serial.println(" Partikel/m³");
    Serial.print("PM10: "); Serial.print(pm10p0, 2); Serial.println(" Partikel/m³");
    Serial.println("-----------------------\n");
}
