#include <Wire.h>
#include "SensirionI2CSen5x.h"

// SEN55-Sensor
SensirionI2CSen5x sensor;

// Intervall für Messungen (10 Sekunden)
const unsigned long intervall = 10000;
unsigned long letzteMessung = 0;

void setup() {
    // Serielle Verbindung starten
    Serial.begin(115200);
    Wire.begin();

    // Sensor initialisieren
    Serial.println("Sensor wird initialisiert...");
    sensor.begin(Wire);
    if (sensor.deviceReset()) {
        Serial.println("Fehler: Sensor konnte nicht initialisiert werden!");
        while (true); // Stoppt das Programm
    }

    Serial.println("Sensor erfolgreich initialisiert.");
}

void loop() {
    // Prüfen, ob das Intervall abgelaufen ist
    if (millis() - letzteMessung >= intervall) {
        letzteMessung = millis();
        leseSensordaten();
    }
}

void leseSensordaten() {
    // Variablen für Massenkonzentrationen
    float pm1p0Mass, pm2p5Mass, pm4p0Mass, pm10p0Mass;

    // Variablen für Partikelanzahlen
    float pm0p5Count, pm1p0Count, pm2p5Count, pm4p0Count, pm10p0Count;

    // Variablen für Temperatur und Luftfeuchtigkeit
    float temperatur, luftfeuchtigkeit;

    // Dummy-Variablen für Luftqualitätsindizes (wird nicht genutzt)
    float vocIndex, noxIndex;

    // Sensordaten lesen
    if (sensor.readMeasuredPmValues(
            pm1p0Mass, pm2p5Mass, pm4p0Mass, pm10p0Mass,  // Massenkonzentrationen
            pm0p5Count, pm1p0Count,                       // Partikelanzahlen für PM0.5 und PM1.0
            temperatur, luftfeuchtigkeit,                 // Temperatur und Luftfeuchtigkeit
            vocIndex, noxIndex)) {                        // Luftqualitätsindizes
        Serial.println("Fehler beim Lesen der Sensordaten.");
        return;
    }

    // Sensordaten auf dem Serial Monitor ausgeben
    Serial.println("----- Sensordaten -----");
    Serial.print("Temperatur: "); Serial.print(temperatur, 2); Serial.println(" °C");
    Serial.print("Luftfeuchtigkeit: "); Serial.print(luftfeuchtigkeit, 2); Serial.println(" %");
    Serial.print("PM0.5: "); Serial.print(pm0p5Count, 2); Serial.println(" Partikel/m³");
    Serial.print("PM1.0: "); Serial.print(pm1p0Count, 2); Serial.println(" Partikel/m³");
    Serial.print("PM2.5: "); Serial.print(pm2p5Mass, 2); Serial.println(" Partikel/m³");
    Serial.print("PM4.0: "); Serial.print(pm4p0Mass, 2); Serial.println(" Partikel/m³");
    Serial.print("PM10: "); Serial.print(pm10p0Mass, 2); Serial.println(" Partikel/m³");
    Serial.println("-----------------------------\n");
}
